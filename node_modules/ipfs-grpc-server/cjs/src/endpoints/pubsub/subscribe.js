'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var subscriptions = require('./subscriptions.js');
var nanoid = require('nanoid');

function grpcPubsubSubscribe(ipfs, options = {}) {
  async function pubsubSubscribe(request, sink, metadata) {
    const opts = { ...metadata };
    const handlerId = nanoid.nanoid();
    const handler = {
      onMessage: message => {
        sink.push(message);
      },
      onUnsubscribe: () => {
        sink.end();
      }
    };
    subscriptions.subscriptions.set(handlerId, handler);
    sink.push({ handler: handlerId });
    await ipfs.pubsub.subscribe(request.topic, handler.onMessage, opts);
  }
  return pubsubSubscribe;
}

exports.grpcPubsubSubscribe = grpcPubsubSubscribe;
