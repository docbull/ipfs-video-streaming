import { subscriptions } from './subscriptions.js';
import { nanoid } from 'nanoid';
export function grpcPubsubSubscribe(ipfs, options = {}) {
  async function pubsubSubscribe(request, sink, metadata) {
    const opts = { ...metadata };
    const handlerId = nanoid();
    const handler = {
      onMessage: message => {
        sink.push(message);
      },
      onUnsubscribe: () => {
        sink.end();
      }
    };
    subscriptions.set(handlerId, handler);
    sink.push({ handler: handlerId });
    await ipfs.pubsub.subscribe(request.topic, handler.onMessage, opts);
  }
  return pubsubSubscribe;
}