(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.DatastorePubsub = factory()}(typeof self !== 'undefined' ? self : this, function () {
var DatastorePubsub=(()=>{var cr=Object.create;var oe=Object.defineProperty;var ur=Object.getOwnPropertyDescriptor;var fr=Object.getOwnPropertyNames;var dr=Object.getPrototypeOf,hr=Object.prototype.hasOwnProperty;var rt=t=>oe(t,"__esModule",{value:!0});var C=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),S=(t,e)=>{rt(t);for(var r in e)oe(t,r,{get:e[r],enumerable:!0})},lr=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of fr(e))!hr.call(t,s)&&s!=="default"&&oe(t,s,{get:()=>e[s],enumerable:!(r=ur(e,s))||r.enumerable});return t},x=t=>lr(rt(oe(t!=null?cr(dr(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var he=C((Zn,It)=>{"use strict";function Dt(t,e){for(let r in e)Object.defineProperty(t,r,{value:e[r],enumerable:!0,configurable:!0});return t}function xs(t,e,r){if(!t||typeof t=="string")throw new TypeError("Please pass an Error to err-code");r||(r={}),typeof e=="object"&&(r=e,e=""),e&&(r.code=e);try{return Dt(t,r)}catch(s){r.message=t.message,r.stack=t.stack;let n=function(){};return n.prototype=Object.create(Object.getPrototypeOf(t)),Dt(new n,r)}}It.exports=xs});var Tt=C((so,Nt)=>{"use strict";var vs=async t=>{let e=[];for await(let r of t)e.push(r);return e};Nt.exports=vs});var We=C((oo,Lt)=>{"use strict";var Cs=async t=>{for await(let e of t);};Lt.exports=Cs});var Ge=C((io,Ut)=>{"use strict";var Ss=async function*(t,e){for await(let r of t)await e(r)&&(yield r)};Ut.exports=Ss});var Je=C((ao,kt)=>{"use strict";var As=async function*(t,e){let r=0;if(!(e<1)){for await(let s of t)if(yield s,r++,r===e)return}};kt.exports=As});var Bt=C((mo,Pt)=>{"use strict";var Fs=async function*(t,e){for await(let r of t)yield e(r)};Pt.exports=Fs});var zt=C((yo,G)=>{var Kt=(...t)=>{let e;for(;t.length;)e=t.shift()(e);return e},Xe=t=>t&&(typeof t[Symbol.asyncIterator]=="function"||typeof t[Symbol.iterator]=="function"||typeof t.next=="function"),be=t=>t&&typeof t.sink=="function"&&Xe(t.source),_s=t=>e=>(t.sink(e),t.source),Vt=(...t)=>{if(be(t[0])){let e=t[0];t[0]=()=>e.source}else if(Xe(t[0])){let e=t[0];t[0]=()=>e}if(t.length>1&&be(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let e=1;e<t.length-1;e++)be(t[e])&&(t[e]=_s(t[e]));return Kt(...t)};G.exports=Vt;G.exports.pipe=Vt;G.exports.rawPipe=Kt;G.exports.isIterable=Xe;G.exports.isDuplex=be});var Gt=C((Ro,Wt)=>{Wt.exports=class{constructor(e){if(!(e>0)||(e-1&e)!=0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}});var Ht=C((Io,Yt)=>{var Jt=Gt();Yt.exports=class{constructor(e){this.hwm=e||16,this.head=new Jt(this.hwm),this.tail=this.head}push(e){if(!this.head.push(e)){let r=this.head;this.head=r.next=new Jt(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next){let r=this.tail.next;return this.tail.next=null,this.tail=r,this.tail.shift()}return e}isEmpty(){return this.head.isEmpty()}}});var qe=C((jo,Xt)=>{var Ze=Ht();Xt.exports=t=>{t=t||{};let e;typeof t=="function"?(e=t,t={}):e=t.onEnd;let r=new Ze,s,n,o,c=()=>{if(!r.isEmpty()){if(t.writev){let f,d=[];for(;!r.isEmpty();){if(f=r.shift(),f.error)throw f.error;d.push(f.value)}return{done:f.done,value:d}}let i=r.shift();if(i.error)throw i.error;return i}return o?{done:!0}:new Promise((i,f)=>{n=d=>(n=null,d.error?f(d.error):t.writev&&!d.done?i({done:d.done,value:[d.value]}):i(d),s)})},h=i=>n?n(i):(r.push(i),s),b=i=>(r=new Ze,n?n({error:i}):(r.push({error:i}),s)),j=i=>o?s:h({done:!1,value:i}),a=i=>o?s:(o=!0,i?b(i):h({done:!0})),u=()=>(r=new Ze,a(),{done:!0}),l=i=>(a(i),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:u,throw:l,push:j,end:a},!e)return s;let M=s;return s={[Symbol.asyncIterator](){return this},next(){return M.next()},throw(i){return M.throw(i),e&&(e(i),e=null),{done:!0}},return(){return M.return(),e&&(e(),e=null),{done:!0}},push:j,end(i){return M.end(i),e&&(e(i),e=null),s}},s}});var qt=C((Mo,Zt)=>{"use strict";var Is=qe(),js=async function*(...t){let e=Is();setTimeout(async()=>{try{await Promise.all(t.map(async r=>{for await(let s of r)e.push(s)})),e.end()}catch(r){e.end(r)}},0),yield*e};Zt.exports=js});var er=C((Uo,Qt)=>{var J=1e3,Y=J*60,H=Y*60,B=H*24,Os=B*7,Ls=B*365.25;Qt.exports=function(t,e){e=e||{};var r=typeof t;if(r==="string"&&t.length>0)return Us(t);if(r==="number"&&isFinite(t))return e.long?Ps(t):ks(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function Us(t){if(t=String(t),!(t.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(!!e){var r=parseFloat(e[1]),s=(e[2]||"ms").toLowerCase();switch(s){case"years":case"year":case"yrs":case"yr":case"y":return r*Ls;case"weeks":case"week":case"w":return r*Os;case"days":case"day":case"d":return r*B;case"hours":case"hour":case"hrs":case"hr":case"h":return r*H;case"minutes":case"minute":case"mins":case"min":case"m":return r*Y;case"seconds":case"second":case"secs":case"sec":case"s":return r*J;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}function ks(t){var e=Math.abs(t);return e>=B?Math.round(t/B)+"d":e>=H?Math.round(t/H)+"h":e>=Y?Math.round(t/Y)+"m":e>=J?Math.round(t/J)+"s":t+"ms"}function Ps(t){var e=Math.abs(t);return e>=B?ge(t,e,B,"day"):e>=H?ge(t,e,H,"hour"):e>=Y?ge(t,e,Y,"minute"):e>=J?ge(t,e,J,"second"):t+" ms"}function ge(t,e,r,s){var n=e>=r*1.5;return Math.round(t/r)+" "+s+(n?"s":"")}});var rr=C((ko,tr)=>{function Bs(t){r.debug=r,r.default=r,r.coerce=b,r.disable=o,r.enable=n,r.enabled=c,r.humanize=er(),r.destroy=j,Object.keys(t).forEach(a=>{r[a]=t[a]}),r.names=[],r.skips=[],r.formatters={};function e(a){let u=0;for(let l=0;l<a.length;l++)u=(u<<5)-u+a.charCodeAt(l),u|=0;return r.colors[Math.abs(u)%r.colors.length]}r.selectColor=e;function r(a){let u,l=null,M,i;function f(...d){if(!f.enabled)return;let y=f,v=Number(new Date),R=v-(u||v);y.diff=R,y.prev=u,y.curr=v,u=v,d[0]=r.coerce(d[0]),typeof d[0]!="string"&&d.unshift("%O");let w=0;d[0]=d[0].replace(/%([a-zA-Z%])/g,(D,A)=>{if(D==="%%")return"%";w++;let I=r.formatters[A];if(typeof I=="function"){let K=d[w];D=I.call(y,K),d.splice(w,1),w--}return D}),r.formatArgs.call(y,d),(y.log||r.log).apply(y,d)}return f.namespace=a,f.useColors=r.useColors(),f.color=r.selectColor(a),f.extend=s,f.destroy=r.destroy,Object.defineProperty(f,"enabled",{enumerable:!0,configurable:!1,get:()=>l!==null?l:(M!==r.namespaces&&(M=r.namespaces,i=r.enabled(a)),i),set:d=>{l=d}}),typeof r.init=="function"&&r.init(f),f}function s(a,u){let l=r(this.namespace+(typeof u=="undefined"?":":u)+a);return l.log=this.log,l}function n(a){r.save(a),r.namespaces=a,r.names=[],r.skips=[];let u,l=(typeof a=="string"?a:"").split(/[\s,]+/),M=l.length;for(u=0;u<M;u++)!l[u]||(a=l[u].replace(/\*/g,".*?"),a[0]==="-"?r.skips.push(new RegExp("^"+a.substr(1)+"$")):r.names.push(new RegExp("^"+a+"$")))}function o(){let a=[...r.names.map(h),...r.skips.map(h).map(u=>"-"+u)].join(",");return r.enable(""),a}function c(a){if(a[a.length-1]==="*")return!0;let u,l;for(u=0,l=r.skips.length;u<l;u++)if(r.skips[u].test(a))return!1;for(u=0,l=r.names.length;u<l;u++)if(r.names[u].test(a))return!0;return!1}function h(a){return a.toString().substring(2,a.toString().length-2).replace(/\.\*\?$/,"*")}function b(a){return a instanceof Error?a.stack||a.message:a}function j(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}tr.exports=Bs});var Qe=C((F,we)=>{F.formatArgs=Vs;F.save=zs;F.load=$s;F.useColors=Ks;F.storage=Ws();F.destroy=(()=>{let t=!1;return()=>{t||(t=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();F.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Ks(){return typeof window!="undefined"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document!="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Vs(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+we.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;t.splice(1,0,e,"color: inherit");let r=0,s=0;t[0].replace(/%[a-zA-Z%]/g,n=>{n!=="%%"&&(r++,n==="%c"&&(s=r))}),t.splice(s,0,e)}F.log=console.debug||console.log||(()=>{});function zs(t){try{t?F.storage.setItem("debug",t):F.storage.removeItem("debug")}catch(e){}}function $s(){let t;try{t=F.storage.getItem("debug")}catch(e){}return!t&&typeof process!="undefined"&&"env"in process&&(t=process.env.DEBUG),t}function Ws(){try{return localStorage}catch(t){}}we.exports=rr()(F);var{formatters:Gs}=we.exports;Gs.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var Hs={};S(Hs,{PubsubDatastore:()=>ar});var st=(t=21)=>{let e="",r=crypto.getRandomValues(new Uint8Array(t));for(;t--;){let s=r[t]&63;s<36?e+=s.toString(36):s<62?e+=(s-26).toString(36).toUpperCase():s<63?e+="_":e+="-"}return e};var Ee={};S(Ee,{identity:()=>wr});function pr(t,e){if(t.length>=255)throw new TypeError("Alphabet too long");for(var r=new Uint8Array(256),s=0;s<r.length;s++)r[s]=255;for(var n=0;n<t.length;n++){var o=t.charAt(n),c=o.charCodeAt(0);if(r[c]!==255)throw new TypeError(o+" is ambiguous");r[c]=n}var h=t.length,b=t.charAt(0),j=Math.log(h)/Math.log(256),a=Math.log(256)/Math.log(h);function u(i){if(i instanceof Uint8Array||(ArrayBuffer.isView(i)?i=new Uint8Array(i.buffer,i.byteOffset,i.byteLength):Array.isArray(i)&&(i=Uint8Array.from(i))),!(i instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(i.length===0)return"";for(var f=0,d=0,y=0,v=i.length;y!==v&&i[y]===0;)y++,f++;for(var R=(v-y)*a+1>>>0,w=new Uint8Array(R);y!==v;){for(var N=i[y],D=0,A=R-1;(N!==0||D<d)&&A!==-1;A--,D++)N+=256*w[A]>>>0,w[A]=N%h>>>0,N=N/h>>>0;if(N!==0)throw new Error("Non-zero carry");d=D,y++}for(var I=R-d;I!==R&&w[I]===0;)I++;for(var K=b.repeat(f);I<R;++I)K+=t.charAt(w[I]);return K}function l(i){if(typeof i!="string")throw new TypeError("Expected String");if(i.length===0)return new Uint8Array;var f=0;if(i[f]!==" "){for(var d=0,y=0;i[f]===b;)d++,f++;for(var v=(i.length-f)*j+1>>>0,R=new Uint8Array(v);i[f];){var w=r[i.charCodeAt(f)];if(w===255)return;for(var N=0,D=v-1;(w!==0||N<y)&&D!==-1;D--,N++)w+=h*R[D]>>>0,R[D]=w%256>>>0,w=w/256>>>0;if(w!==0)throw new Error("Non-zero carry");y=N,f++}if(i[f]!==" "){for(var A=v-y;A!==v&&R[A]===0;)A++;for(var I=new Uint8Array(d+(v-A)),K=d;A!==v;)I[K++]=R[A++];return I}}}function M(i){var f=l(i);if(f)return f;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:l,decode:M}}var mr=pr,yr=mr,nt=yr;var rn=new Uint8Array(0);var ot=(t,e)=>{if(t===e)return!0;if(t.byteLength!==e.byteLength)return!1;for(let r=0;r<t.byteLength;r++)if(t[r]!==e[r])return!1;return!0},O=t=>{if(t instanceof Uint8Array&&t.constructor.name==="Uint8Array")return t;if(t instanceof ArrayBuffer)return new Uint8Array(t);if(ArrayBuffer.isView(t))return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);throw new Error("Unknown type, must be binary type")};var it=t=>new TextEncoder().encode(t),at=t=>new TextDecoder().decode(t);var ut=class{constructor(e,r,s){this.name=e,this.prefix=r,this.baseEncode=s}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},ft=class{constructor(e,r,s){this.name=e,this.prefix=r,this.baseDecode=s}decode(e){if(typeof e=="string")switch(e[0]){case this.prefix:return this.baseDecode(e.slice(1));default:throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`)}else throw Error("Can only multibase decode strings")}or(e){return ht(this,e)}},dt=class{constructor(e){this.decoders=e}or(e){return ht(this,e)}decode(e){let r=e[0],s=this.decoders[r];if(s)return s.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},ht=(t,e)=>new dt({...t.decoders||{[t.prefix]:t},...e.decoders||{[e.prefix]:e}}),lt=class{constructor(e,r,s,n){this.name=e,this.prefix=r,this.baseEncode=s,this.baseDecode=n,this.encoder=new ut(e,r,s),this.decoder=new ft(e,r,n)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},ie=({name:t,prefix:e,encode:r,decode:s})=>new lt(t,e,r,s),k=({prefix:t,name:e,alphabet:r})=>{let{encode:s,decode:n}=nt(r,e);return ie({prefix:t,name:e,encode:s,decode:o=>O(n(o))})},br=(t,e,r,s)=>{let n={};for(let a=0;a<e.length;++a)n[e[a]]=a;let o=t.length;for(;t[o-1]==="=";)--o;let c=new Uint8Array(o*r/8|0),h=0,b=0,j=0;for(let a=0;a<o;++a){let u=n[t[a]];if(u===void 0)throw new SyntaxError(`Non-${s} character`);b=b<<r|u,h+=r,h>=8&&(h-=8,c[j++]=255&b>>h)}if(h>=r||255&b<<8-h)throw new SyntaxError("Unexpected end of data");return c},gr=(t,e,r)=>{let s=e[e.length-1]==="=",n=(1<<r)-1,o="",c=0,h=0;for(let b=0;b<t.length;++b)for(h=h<<8|t[b],c+=8;c>r;)c-=r,o+=e[n&h>>c];if(c&&(o+=e[n&h<<r-c]),s)for(;o.length*r&7;)o+="=";return o},m=({name:t,prefix:e,bitsPerChar:r,alphabet:s})=>ie({prefix:e,name:t,encode(n){return gr(n,s,r)},decode(n){return br(n,s,r,t)}});var wr=ie({prefix:"\0",name:"identity",encode:t=>at(t),decode:t=>it(t)});var ve={};S(ve,{base2:()=>xr});var xr=m({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Ce={};S(Ce,{base8:()=>Er});var Er=m({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Se={};S(Se,{base10:()=>vr});var vr=k({prefix:"9",name:"base10",alphabet:"0123456789"});var Ae={};S(Ae,{base16:()=>Cr,base16upper:()=>Sr});var Cr=m({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Sr=m({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var Fe={};S(Fe,{base32:()=>V,base32hex:()=>Rr,base32hexpad:()=>Ir,base32hexpadupper:()=>jr,base32hexupper:()=>Dr,base32pad:()=>Fr,base32padupper:()=>_r,base32upper:()=>Ar,base32z:()=>Mr});var V=m({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Ar=m({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Fr=m({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),_r=m({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Rr=m({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Dr=m({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Ir=m({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),jr=m({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Mr=m({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var _e={};S(_e,{base36:()=>Nr,base36upper:()=>Tr});var Nr=k({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Tr=k({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Re={};S(Re,{base58btc:()=>T,base58flickr:()=>Or});var T=k({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Or=k({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var De={};S(De,{base64:()=>Lr,base64pad:()=>Ur,base64url:()=>kr,base64urlpad:()=>Pr});var Lr=m({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Ur=m({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),kr=m({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Pr=m({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var je={};S(je,{sha256:()=>ns,sha512:()=>os});var Br=mt,pt=128,Kr=127,Vr=~Kr,zr=Math.pow(2,31);function mt(t,e,r){e=e||[],r=r||0;for(var s=r;t>=zr;)e[r++]=t&255|pt,t/=128;for(;t&Vr;)e[r++]=t&255|pt,t>>>=7;return e[r]=t|0,mt.bytes=r-s+1,e}var $r=Ie,Wr=128,yt=127;function Ie(t,e){var r=0,e=e||0,s=0,n=e,o,c=t.length;do{if(n>=c)throw Ie.bytes=0,new RangeError("Could not decode varint");o=t[n++],r+=s<28?(o&yt)<<s:(o&yt)*Math.pow(2,s),s+=7}while(o>=Wr);return Ie.bytes=n-e,r}var Gr=Math.pow(2,7),Jr=Math.pow(2,14),Yr=Math.pow(2,21),Hr=Math.pow(2,28),Xr=Math.pow(2,35),Zr=Math.pow(2,42),qr=Math.pow(2,49),Qr=Math.pow(2,56),es=Math.pow(2,63),ts=function(t){return t<Gr?1:t<Jr?2:t<Yr?3:t<Hr?4:t<Xr?5:t<Zr?6:t<qr?7:t<Qr?8:t<es?9:10},rs={encode:Br,decode:$r,encodingLength:ts},ss=rs,X=ss;var Z=t=>[X.decode(t),X.decode.bytes],z=(t,e,r=0)=>(X.encode(t,e,r),e),$=t=>X.encodingLength(t);var ae=(t,e)=>{let r=e.byteLength,s=$(t),n=s+$(r),o=new Uint8Array(n+r);return z(t,o,0),z(r,o,s),o.set(e,n),new q(t,r,e,o)},gt=t=>{let e=O(t),[r,s]=Z(e),[n,o]=Z(e.subarray(s)),c=e.subarray(s+o);if(c.byteLength!==n)throw new Error("Incorrect length");return new q(r,n,c,e)},wt=(t,e)=>t===e?!0:t.code===e.code&&t.size===e.size&&ot(t.bytes,e.bytes),q=class{constructor(e,r,s,n){this.code=e,this.size=r,this.digest=s,this.bytes=n}};var Q=({name:t,code:e,encode:r})=>new Et(t,e,r),Et=class{constructor(e,r,s){this.name=e,this.code=r,this.encode=s}async digest(e){if(e instanceof Uint8Array){let r=await this.encode(e);return ae(this.code,r)}else throw Error("Unknown type, must be binary type")}};var Ct=t=>async e=>new Uint8Array(await crypto.subtle.digest(t,e)),ns=Q({name:"sha2-256",code:18,encode:Ct("SHA-256")}),os=Q({name:"sha2-512",code:19,encode:Ct("SHA-512")});var Me={};S(Me,{identity:()=>is});var is=Q({name:"identity",code:0,encode:t=>O(t)});var Fn=new TextEncoder,_n=new TextDecoder;var g=class{constructor(e,r,s,n){this.code=r,this.version=e,this.multihash=s,this.bytes=n,this.byteOffset=n.byteOffset,this.byteLength=n.byteLength,this.asCID=this,this._baseCache=new Map,Object.defineProperties(this,{byteOffset:ue,byteLength:ue,code:ce,version:ce,multihash:ce,bytes:ce,_baseCache:ue,asCID:ue})}toV0(){switch(this.version){case 0:return this;default:{let{code:e,multihash:r}=this;if(e!==ee)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(r.code!==hs)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return g.createV0(r)}}}toV1(){switch(this.version){case 0:{let{code:e,digest:r}=this.multihash,s=ae(e,r);return g.createV1(this.code,s)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}equals(e){return e&&this.code===e.code&&this.version===e.version&&wt(this.multihash,e.multihash)}toString(e){let{bytes:r,version:s,_baseCache:n}=this;switch(s){case 0:return fs(r,n,e||T.encoder);default:return ds(r,n,e||V.encoder)}}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID("+this.toString()+")"}static isCID(e){return ps(/^0\.0/,ms),!!(e&&(e[At]||e.asCID===e))}get toBaseEncodedString(){throw new Error("Deprecated, use .toString()")}get codec(){throw new Error('"codec" property is deprecated, use integer "code" property instead')}get buffer(){throw new Error("Deprecated .buffer property, use .bytes to get Uint8Array instead")}get multibaseName(){throw new Error('"multibaseName" property is deprecated')}get prefix(){throw new Error('"prefix" property is deprecated')}static asCID(e){if(e instanceof g)return e;if(e!=null&&e.asCID===e){let{version:r,code:s,multihash:n,bytes:o}=e;return new g(r,s,n,o||St(r,s,n.bytes))}else if(e!=null&&e[At]===!0){let{version:r,multihash:s,code:n}=e,o=gt(s);return g.create(r,n,o)}else return null}static create(e,r,s){if(typeof r!="number")throw new Error("String codecs are no longer supported");switch(e){case 0:{if(r!==ee)throw new Error(`Version 0 CID must use dag-pb (code: ${ee}) block encoding`);return new g(e,r,s,s.bytes)}case 1:{let n=St(e,r,s.bytes);return new g(e,r,s,n)}default:throw new Error("Invalid version")}}static createV0(e){return g.create(0,ee,e)}static createV1(e,r){return g.create(1,e,r)}static decode(e){let[r,s]=g.decodeFirst(e);if(s.length)throw new Error("Incorrect length");return r}static decodeFirst(e){let r=g.inspectBytes(e),s=r.size-r.multihashSize,n=O(e.subarray(s,s+r.multihashSize));if(n.byteLength!==r.multihashSize)throw new Error("Incorrect length");let o=n.subarray(r.multihashSize-r.digestSize),c=new q(r.multihashCode,r.digestSize,o,n);return[r.version===0?g.createV0(c):g.createV1(r.codec,c),e.subarray(r.size)]}static inspectBytes(e){let r=0,s=()=>{let[u,l]=Z(e.subarray(r));return r+=l,u},n=s(),o=ee;if(n===18?(n=0,r=0):n===1&&(o=s()),n!==0&&n!==1)throw new RangeError(`Invalid CID version ${n}`);let c=r,h=s(),b=s(),j=r+b,a=j-c;return{version:n,codec:o,multihashCode:h,digestSize:b,multihashSize:a,size:j}}static parse(e,r){let[s,n]=us(e,r),o=g.decode(n);return o._baseCache.set(s,e),o}},us=(t,e)=>{switch(t[0]){case"Q":{let r=e||T;return[T.prefix,r.decode(`${T.prefix}${t}`)]}case T.prefix:{let r=e||T;return[T.prefix,r.decode(t)]}case V.prefix:{let r=e||V;return[V.prefix,r.decode(t)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[t[0],e.decode(t)]}}},fs=(t,e,r)=>{let{prefix:s}=r;if(s!==T.prefix)throw Error(`Cannot string encode V0 in ${r.name} encoding`);let n=e.get(s);if(n==null){let o=r.encode(t).slice(1);return e.set(s,o),o}else return n},ds=(t,e,r)=>{let{prefix:s}=r,n=e.get(s);if(n==null){let o=r.encode(t);return e.set(s,o),o}else return n},ee=112,hs=18,St=(t,e,r)=>{let s=$(t),n=s+$(e),o=new Uint8Array(n+r.byteLength);return z(t,o,0),z(e,o,s),o.set(r,n),o},At=Symbol.for("@ipld/js-cid/CID"),ce={writable:!1,configurable:!1,enumerable:!0},ue={writable:!1,enumerable:!1,configurable:!1},ls="0.0.0-dev",ps=(t,e)=>{if(t.test(ls))console.warn(e);else throw new Error(e)},ms=`CID.isCID(v) is deprecated and will be removed in the next major release.
Following code pattern:

if (CID.isCID(value)) {
  doSomethingWithCID(value)
}

Is replaced with:

const cid = CID.asCID(value)
if (cid) {
  // Make sure to use cid instead of value
  doSomethingWithCID(cid)
}
`;var Ne={...Ee,...ve,...Ce,...Se,...Ae,...Fe,..._e,...Re,...De},Un={...je,...Me};function Ft(t,e,r,s){return{name:t,prefix:e,encoder:{name:t,prefix:e,encode:r},decoder:{decode:s}}}var _t=Ft("utf8","u",t=>{let e=new TextDecoder("utf8");return"u"+e.decode(t)},t=>new TextEncoder().encode(t.substring(1))),Te=Ft("ascii","a",t=>{let e="a";for(let r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return e},t=>{t=t.substring(1);let e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e}),ys={utf8:_t,"utf-8":_t,hex:Ne.base16,latin1:Te,ascii:Te,binary:Te,...Ne},fe=ys;function te(t,e="utf8"){let r=fe[e];if(!r)throw new Error(`Unsupported encoding "${e}"`);return r.encoder.encode(t).substring(1)}function re(t,e="utf8"){let r=fe[e];if(!r)throw new Error(`Unsupported encoding "${e}"`);return r.decoder.decode(`${r.prefix}${t}`)}var L="/",Rt=new TextEncoder().encode(L),de=Rt[0],p=class{constructor(e,r){if(typeof e=="string")this._buf=re(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(r==null&&(r=!0),r&&this.clean(),this._buf.byteLength===0||this._buf[0]!==de)throw new Error("Invalid key")}toString(e="utf8"){return te(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new p(e.join(L))}static random(){return new p(st().replace(/-/g,""))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new p(e):e.uint8Array?new p(e.uint8Array()):null}clean(){if((!this._buf||this._buf.byteLength===0)&&(this._buf=Rt),this._buf[0]!==de){let e=new Uint8Array(this._buf.byteLength+1);e.fill(de,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===de;)this._buf=this._buf.subarray(0,-1)}less(e){let r=this.list(),s=e.list();for(let n=0;n<r.length;n++){if(s.length<n+1)return!1;let o=r[n],c=s[n];if(o<c)return!0;if(o>c)return!1}return r.length<s.length}reverse(){return p.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(L).slice(1)}type(){return bs(this.baseNamespace())}name(){return gs(this.baseNamespace())}instance(e){return new p(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(L)||(e+=L),e+=this.type(),new p(e)}parent(){let e=this.list();return e.length===1?new p(L):new p(e.slice(0,-1).join(L))}child(e){return this.toString()===L?e:e.toString()===L?this:new p(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return p.withNamespaces([...this.namespaces(),...ws(e.map(r=>r.namespaces()))])}};function bs(t){let e=t.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function gs(t){let e=t.split(":");return e[e.length-1]}function ws(t){return[].concat(...t)}var ke={};S(ke,{abortedError:()=>Es,dbDeleteFailedError:()=>Le,dbOpenFailedError:()=>Oe,dbWriteFailedError:()=>Ue,notFoundError:()=>le});var W=x(he());function Oe(t){return t=t||new Error("Cannot open database"),(0,W.default)(t,"ERR_DB_OPEN_FAILED")}function Le(t){return t=t||new Error("Delete failed"),(0,W.default)(t,"ERR_DB_DELETE_FAILED")}function Ue(t){return t=t||new Error("Write failed"),(0,W.default)(t,"ERR_DB_WRITE_FAILED")}function le(t){return t=t||new Error("Not Found"),(0,W.default)(t,"ERR_NOT_FOUND")}function Es(t){return t=t||new Error("Aborted"),(0,W.default)(t,"ERR_ABORTED")}var $e={};S($e,{NextToLast:()=>ze,PREFIX:()=>pe,Prefix:()=>Ke,README_FN:()=>Be,SHARDING_FN:()=>me,ShardBase:()=>se,Suffix:()=>Ve,parseShardFun:()=>jt,readShardFun:()=>Mt,readme:()=>Pe});var Pe=`This is a repository of IPLD objects. Each IPLD object is in a single file,
named <base32 encoding of cid>.data. Where <base32 encoding of cid> is the
"base32" encoding of the CID (as specified in
https://github.com/multiformats/multibase) without the 'B' prefix.
All the object files are placed in a tree of directories, based on a
function of the CID. This is a form of sharding similar to
the objects directory in git repositories. Previously, we used
prefixes, we now use the next-to-last two charters.
    func NextToLast(base32cid string) {
      nextToLastLen := 2
      offset := len(base32cid) - nextToLastLen - 1
      return str[offset : offset+nextToLastLen]
    }
For example, an object with a base58 CIDv1 of
    zb2rhYSxw4ZjuzgCnWSt19Q94ERaeFhu9uSqRgjSdx9bsgM6f
has a base32 CIDv1 of
    BAFKREIA22FLID5AJ2KU7URG47MDLROZIH6YF2KALU2PWEFPVI37YLKRSCA
and will be placed at
    SC/AFKREIA22FLID5AJ2KU7URG47MDLROZIH6YF2KALU2PWEFPVI37YLKRSCA.data
with 'SC' being the last-to-next two characters and the 'B' at the
beginning of the CIDv1 string is the multibase prefix that is not
stored in the filename.
`;var pe="/repo/flatfs/shard/",me="SHARDING",Be="_README",se=class{constructor(e){this.param=e,this.name="base",this._padding=""}fun(e){return"implement me"}toString(){return`${pe}v1/${this.name}/${this.param}`}},Ke=class extends se{constructor(e){super(e);this._padding="".padStart(e,"_"),this.name="prefix"}fun(e){return(e+this._padding).slice(0,this.param)}},Ve=class extends se{constructor(e){super(e);this._padding="".padStart(e,"_"),this.name="suffix"}fun(e){let r=this._padding+e;return r.slice(r.length-this.param)}},ze=class extends se{constructor(e){super(e);this._padding="".padStart(e+1,"_"),this.name="next-to-last"}fun(e){let r=this._padding+e,s=r.length-this.param-1;return r.slice(s,s+this.param)}};function jt(t){if(t=t.trim(),t.length===0)throw new Error("empty shard string");if(!t.startsWith(pe))throw new Error(`invalid or no path prefix: ${t}`);let e=t.slice(pe.length).split("/"),r=e[0];if(r!=="v1")throw new Error(`expect 'v1' version, got '${r}'`);let s=e[1];if(!e[2])throw new Error("missing param");let n=parseInt(e[2],10);switch(s){case"prefix":return new Ke(n);case"suffix":return new Ve(n);case"next-to-last":return new ze(n);default:throw new Error(`unkown sharding function: ${s}`)}}var Mt=async(t,e)=>{let r=new p(t).child(new p(me)),n=await(typeof e.getRaw=="function"?e.getRaw.bind(e):e.get.bind(e))(r);return jt(new TextDecoder().decode(n||"").trim())};var Ot=x(Tt()),ye=(t,e)=>async function*(){yield*(await(0,Ot.default)(t)).sort(e)}();var Ye=x(We()),P=x(Ge()),He=x(Je()),U=class{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,r,s){return Promise.reject(new Error(".put is not implemented"))}get(e,r){return Promise.reject(new Error(".get is not implemented"))}has(e,r){return Promise.reject(new Error(".has is not implemented"))}delete(e,r){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,r={}){for await(let{key:s,value:n}of e)await this.put(s,n,r),yield{key:s,value:n}}async*getMany(e,r={}){for await(let s of e)yield this.get(s,r)}async*deleteMany(e,r={}){for await(let s of e)await this.delete(s,r),yield s}batch(){let e=[],r=[];return{put(s,n){e.push({key:s,value:n})},delete(s){r.push(s)},commit:async s=>{await(0,Ye.default)(this.putMany(e,s)),e=[],await(0,Ye.default)(this.deleteMany(r,s)),r=[]}}}async*_all(e,r){throw new Error("._all is not implemented")}async*_allKeys(e,r){throw new Error("._allKeys is not implemented")}query(e,r){let s=this._all(e,r);if(e.prefix!=null&&(s=(0,P.default)(s,n=>n.key.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(s=e.filters.reduce((n,o)=>(0,P.default)(n,o),s)),Array.isArray(e.orders)&&(s=e.orders.reduce((n,o)=>ye(n,o),s)),e.offset!=null){let n=0;s=(0,P.default)(s,()=>n++>=e.offset)}return e.limit!=null&&(s=(0,He.default)(s,e.limit)),s}queryKeys(e,r){let s=this._allKeys(e,r);if(e.prefix!=null&&(s=(0,P.default)(s,n=>n.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(s=e.filters.reduce((n,o)=>(0,P.default)(n,o),s)),Array.isArray(e.orders)&&(s=e.orders.reduce((n,o)=>ye(n,o),s)),e.offset!=null){let n=0;s=(0,P.default)(s,()=>n++>=e.offset)}return e.limit!=null&&(s=(0,He.default)(s,e.limit)),s}};var Rs=x(Bt()),Ds=x(zt());var So=new p(me),Ao=new p(Be);var Ms=x(Ge()),Ns=x(Je()),Ts=x(qt());var sr=x(Qe()),Js=x(qe()),Ys=x(We()),Ko=(0,sr.default)("datastore:core:tiered");var Zo={...ke},qo={...$e};var nr=x(he());var xe="/record/";function et(t){return te(t,"base32")}function ne(t){(typeof t=="string"||t instanceof String)&&(t=re(t.toString()));let e=te(t,"base64url");return`${xe}${e}`}function or(t){if(t.substring(0,xe.length)!==xe)throw(0,nr.default)(new Error("topic received is not from a record"),"ERR_TOPIC_IS_NOT_FROM_RECORD_NAMESPACE");let e=t.substring(xe.length);return re(e,"base64url")}function ir(t,e){if(t===e)return!0;if(t.byteLength!==e.byteLength)return!1;for(let r=0;r<t.byteLength;r++)if(t[r]!==e[r])return!1;return!0}var _=x(he()),tt=x(Qe()),E=Object.assign((0,tt.default)("datastore-pubsub:publisher"),{error:(0,tt.default)("datastore-pubsub:publisher:error")}),ar=class extends U{constructor(e,r,s,n,o){super();if(!n)throw(0,_.default)(new TypeError("missing validator"),"ERR_INVALID_PARAMETERS");if(typeof n.validate!="function")throw(0,_.default)(new TypeError("missing validate function"),"ERR_INVALID_PARAMETERS");if(typeof n.select!="function")throw(0,_.default)(new TypeError("missing select function"),"ERR_INVALID_PARAMETERS");if(o&&typeof o!="function")throw(0,_.default)(new TypeError("invalid subscriptionKeyFn received"),"ERR_INVALID_PARAMETERS");this._pubsub=e,this._datastore=r,this._peerId=s,this._validator=n,this._handleSubscriptionKeyFn=o,this._onMessage=this._onMessage.bind(this)}async put(e,r){if(!(e instanceof Uint8Array)){let n="datastore key does not have a valid format";throw E.error(n),(0,_.default)(new Error(n),"ERR_INVALID_DATASTORE_KEY")}if(!(r instanceof Uint8Array)){let n="received value is not a Uint8Array";throw E.error(n),(0,_.default)(new Error(n),"ERR_INVALID_VALUE_RECEIVED")}let s=ne(e);E(`publish value for topic ${s}`),await this._pubsub.publish(s,r)}async get(e){if(!(e instanceof Uint8Array)){let n="datastore key does not have a valid format";throw E.error(n),(0,_.default)(new Error(n),"ERR_INVALID_DATASTORE_KEY")}let r=ne(e),s=await this._pubsub.getTopics();if(s&&Array.isArray(s)&&s.indexOf(r)>-1)return this._getLocal(e);try{this._pubsub.on(r,this._onMessage),await this._pubsub.subscribe(r)}catch(n){let o=`cannot subscribe topic ${r}`;throw E.error(o),(0,_.default)(new Error(o),"ERR_SUBSCRIBING_TOPIC")}return E(`subscribed values for key ${r}`),this._getLocal(e)}unsubscribe(e){let r=ne(e);return this._pubsub.removeListener(r,this._onMessage),this._pubsub.unsubscribe(r)}async _getLocal(e){let r=new p("/"+et(e),!1),s;try{s=await this._datastore.get(r)}catch(n){if(n.code!=="ERR_NOT_FOUND"){let c=`unexpected error getting the ipns record for ${r.toString()}`;throw E.error(c),(0,_.default)(new Error(c),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}let o=`local record requested was not found for ${r.toString()}`;throw E.error(o),(0,_.default)(new Error(o),"ERR_NOT_FOUND")}if(!(s instanceof Uint8Array)){let n="found record that we couldn't convert to a value";throw E.error(n),(0,_.default)(new Error(n),"ERR_INVALID_RECORD_RECEIVED")}return s}async _onMessage(e){let{data:r,from:s,topicIDs:n}=e,o;try{o=or(n[0])}catch(c){E.error(c);return}if(E(`message received for topic ${n[0]}`),s===this._peerId.toB58String()){E("message discarded as it is from the same peer");return}if(this._handleSubscriptionKeyFn){let c;try{c=await this._handleSubscriptionKeyFn(o)}catch(h){E.error("message discarded by the subscriptionKeyFn");return}o=c}try{await this._storeIfSubscriptionIsBetter(o,r)}catch(c){E.error(c)}}async _storeIfSubscriptionIsBetter(e,r){let s=!1;try{s=await this._isBetter(e,r)}catch(n){if(n.code!=="ERR_NOT_VALID_RECORD")throw n}s&&await this._storeRecord(e,r)}async _validateRecord(e,r){return this._validator.validate(e,r)}async _selectRecord(e,r){return await this._validator.select(e,r)===0}async _isBetter(e,r){try{await this._validateRecord(r,e)}catch(o){let c="record received through pubsub is not valid";throw E.error(c),(0,_.default)(new Error(c),"ERR_NOT_VALID_RECORD")}let s=new p(e),n;try{n=await this._getLocal(s.uint8Array())}catch(o){return!0}return ir(n,r)?!1:this._selectRecord(e,[n,r])}async _storeRecord(e,r){let s=new p("/"+et(e),!1);await this._datastore.put(s,r),E(`record for ${ne(e)} was stored in the datastore`)}};return Hs;})();
return DatastorePubsub}));
